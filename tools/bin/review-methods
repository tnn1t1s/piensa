#!/usr/bin/env python3
"""
Methods & Reproducibility Reviewer: Instrumentation & Pipeline Auditor.

Checks experimental design clarity and reproducibility.
Outputs to stdout for composability.

Usage:
    review-methods paper.md
    review-methods --model openai/gpt-4.5-preview paper.md
    cat paper.md | review-methods -
"""

import argparse
import asyncio
import json
import os
import sys
from pathlib import Path

from dotenv import load_dotenv
from pydantic_ai import Agent
from pydantic_ai.models.openai import OpenAIModel

env_path = Path(__file__).parent.parent.parent / ".env"
load_dotenv(env_path)

CONFIG_PATH = Path(__file__).parent.parent / "config" / "reviewers" / "methods.json"


async def main():
    parser = argparse.ArgumentParser(description="Methods & Reproducibility Reviewer")
    parser.add_argument("input", nargs="?", default="-", help="Paper file (- for stdin)")
    parser.add_argument("--model", "-m", help="Override model from config")
    args = parser.parse_args()

    api_key = os.getenv("OPENROUTER_API_KEY")
    if not api_key:
        print("Error: OPENROUTER_API_KEY not set", file=sys.stderr)
        sys.exit(1)

    with open(CONFIG_PATH) as f:
        config = json.load(f)

    model_name = args.model or config.get("model", "openai/gpt-4.5-preview")
    model = OpenAIModel(model_name, provider='openrouter')
    agent = Agent(model, system_prompt=config["system_prompt"])

    if args.input != "-":
        paper_path = Path(args.input)
        if not paper_path.exists():
            print(f"Error: File not found: {args.input}", file=sys.stderr)
            sys.exit(1)
        paper_content = paper_path.read_text()
    else:
        paper_content = sys.stdin.read()

    if not paper_content.strip():
        print("Error: Empty paper content", file=sys.stderr)
        sys.exit(1)

    print(f"Running methods reviewer ({model_name})...", file=sys.stderr)
    result = await agent.run(f"Please review the following academic paper:\n\n{paper_content}")
    print(result.output)


if __name__ == "__main__":
    asyncio.run(main())
