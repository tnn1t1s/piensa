#!/usr/bin/env python3
"""
Check status of an OpenAI fine-tuning job.

Usage:
    openai-job-status ftjob-xxx
    openai-job-status ftjob-xxx --wait

Output: JSON with job status to stdout
"""

import argparse
import json
import sys
import time

from dotenv import load_dotenv
load_dotenv()

from openai import OpenAI


def log(msg: str):
    """Log to stderr with flush."""
    print(msg, file=sys.stderr, flush=True)


def main():
    parser = argparse.ArgumentParser(description="Check fine-tuning job status")
    parser.add_argument("job_id", help="Fine-tuning job ID")
    parser.add_argument("--wait", "-w", action="store_true", help="Wait for completion")
    args = parser.parse_args()

    client = OpenAI()

    while True:
        job = client.fine_tuning.jobs.retrieve(args.job_id)
        log(f"[openai-job-status] job={args.job_id} status={job.status}")

        if not args.wait or job.status in ["succeeded", "failed", "cancelled"]:
            break

        time.sleep(30)

    output = {
        "job_id": job.id,
        "status": job.status,
        "model": job.model,
        "fine_tuned_model": job.fine_tuned_model,
        "trained_tokens": job.trained_tokens,
        "error": str(job.error) if job.error else None,
    }
    print(json.dumps(output, indent=2))


if __name__ == "__main__":
    main()
